import io
import random
import shutil

import requests

try:
    from typer import Typer, Argument, Option
    from rich.console import Console
    from rich.status import Status
    from rich.progress import track, Progress
except ImportError:
    print("Please install malwarebazaar[cli] if you want to use the cli functionality.")
    raise

from enum import Enum
from json import dumps

from malwarebazaar.api import Bazaar
from malwarebazaar.config import Config
from malwarebazaar.models import Sample
from malwarebazaar.output import print_sample_table, print_vendor_info_table, csv_output, COLORS, format_none
from malwarebazaar.util import check_version


def get_random_color() -> str:
    return random.choice(COLORS)


class QueryTypes(Enum):
    clamav = "clamav"
    filetype = "filetype"
    gimphash = "gimphash"
    hash = "hash"
    icon = "icon"
    imphash = "imphash"
    issuer = "issuer"
    signature = "signature"
    subject = "subject"
    tag = "tag"
    telfhash = "telfhash"
    tlsh = "tlsh"
    yara = "yara"


bazaar_app = Typer(name="MalwareBazaar cli", help="Query MalwareBazaar from the command line!")


@bazaar_app.command(name="init", help="Initialize bazaar config file.")
def init(
        yaraify_key: str = Option(None, "-y", "--yaraify", help="Optional API key from YARAify."),
        malpedia_key: str = Option(None, "-m", "--malpedia", help="Optional API key from Malpedia."),
        api_key: str = Argument(..., help="API key from your MalwareBazaar account.")
):
    c = Console()
    success = Config.init_config(
        api_key,
        yaraify_key,
        malpedia_key
    )
    if success:
        c.print("Successfully set API-Key!")


@bazaar_app.command(name="query", help="Query the MalwareBazaar API.")
def query(
        limit: int = Option(25, "-l", "--limit", help="Limit the amount of objects returned."),
        json: bool = Option(False, "-j", "--json", help="Output raw JSON response."),
        csv: bool = Option(False, "-c", "--csv", help="Output csv."),
        download: bool = Option(False, "-d", "--download", help="Download samples retrieved by query."),
        simple: bool = Option(False, "-s", "--simple", help="Just output SHA256 hashes."),
        query_type: QueryTypes = Argument(..., show_choices=True, help="The type of query to send to the API."),
        query: str = Argument(..., help="The search term to use for the query")
):
    c, ec = Console(), Console(stderr=True, style="bold red")
    bazaar = Bazaar(Config.get_instance().api_key)

    with Status("Querying MalwareBazaar..."):
        if query_type == QueryTypes.hash:
            res = bazaar.query_hash(query)
        elif query_type == QueryTypes.imphash:
            res = bazaar.query_imphash(query, limit=limit)
        elif query_type == QueryTypes.signature:
            res = bazaar.query_signature(query, limit=limit)
        elif query_type == QueryTypes.yara:
            res = bazaar.query_yara(query, limit=limit)
        elif query_type == QueryTypes.filetype:
            res = bazaar.query_filetype(query, limit=limit)
        elif query_type == QueryTypes.clamav:
            res = bazaar.query_clamav_signature(query, limit=limit)
        elif query_type == QueryTypes.tag:
            res = bazaar.query_tag(query, limit=limit)
        elif query_type == QueryTypes.issuer:
            res = bazaar.query_signing_issuer(query)
        elif query_type == QueryTypes.subject:
            res = bazaar.query_signing_subject(query)
        elif query_type == QueryTypes.tlsh:
            res = bazaar.query_tlsh(query, limit=limit)
        elif query_type == QueryTypes.telfhash:
            res = bazaar.query_telfhash(query, limit=limit)
        elif query_type == QueryTypes.gimphash:
            res = bazaar.query_gimphash(query, limit=limit)
        elif query_type == QueryTypes.icon:
            res = bazaar.query_icon_dhash(query, limit=limit)

    if res["query_status"] != "ok":
        ec.print(f"Invalid Bazaar response: {res['query_status']}")
        exit(-1)

    if json:
        c.print(dumps(res["data"], indent=2))
    elif csv:
        samples = [Sample(**sample) for sample in res["data"]]
        c.print("md5,sha1,sha256,imphash,signature")
        for s in samples:
            c.print(
                f"{s.md5_hash},{s.sha1_hash},{s.sha256_hash},{s.imphash},{s.signature}"
            )
    else:
        samples = [Sample(**sample) for sample in res["data"]]
        for sample in samples:
            if simple:
                c.print(sample.sha256_hash)
            else:
                print_sample_table(sample, c)
                if sample.vendor_intel:
                    print_vendor_info_table(sample, c)

        if download:
            for sample in track(samples, description="Downloading samples..."):
                content = bazaar.download_file(sample.sha256_hash)
                with io.open(sample.sha256_hash, "wb") as fh:
                    fh.write(content)


@bazaar_app.command(
    name="recent",
    help="Get information about recently submitted samples. The API allows either the last 100 samples or "
         "samples uploaded in the last 60 minutes. As the amount is quite big, the default output type is "
         "csv."
)
def recent(
        number: bool = Option(False, "-n", "--number", help="Query last 100 samples instead of samples submitted in "
                                                            "the last hour."),
        csv: bool = Option(False, "-c", "--csv", help="CSV output.")
):
    c, ec = Console(), Console(stderr=True, style="bold red")
    bazaar = Bazaar(Config.get_instance().api_key)
    with Status(f"Querying MalwareBazaar..."):
        if number:
            res = bazaar.query_recent("100")
        else:
            res = bazaar.query_recent("time")

    if res["query_status"] != "ok":
        ec.print(f"Invalid Bazaar response: {res['query_status']}")
        exit(-1)

    samples = [Sample(**sample) for sample in res["data"]]
    if csv:
        csv_output(samples)
    else:
        tags = {}
        for sample in samples:
            if sample.signature:
                sig = f"[red1]{sample.signature}[/red1]"
            else:
                sig = format_none("Undetected")
            row = sample.sha256_hash + f" [{sig}]" + " ("
            for idx, tag in enumerate(sample.tags):
                if tag not in tags:
                    tags.update({
                        tag: get_random_color()
                    })
                row += f"[{tags[tag]}]{tag}[/{tags[tag]}]"
                if idx < len(sample.tags) - 1:
                    row += ", "
            row += ")"
            c.print(row)


@bazaar_app.command(
    name="batch",
    help="Download daily malware batches. The DATE_STR argument needs to be in the format of YYYY-mm-dd."
)
def batch(
        output: str = Option(None, "-o", "--output", help="Output file name."),
        quiet: bool = Option(False, "-q", "--quiet",
                             help="Do not display any output. This also uses shutil to write the "
                                  "downloaded chunks direct to the file which *might* speed up your "
                                  "download."),
        hourly: bool = Option(False, "-H", "--hourly",
                              help="Download hourly batches. For hourly batches, the [DATE_STR] needs "
                                   "to be YYYY-mm-dd-HH"),
        chunk_size: int = Option(1024 ** 2, "-c", "--chunk-size", help="Sets chunk size of downloaded chunks "
                                                                       f"(default is {1024 ** 2}). "
                                                                       f"This can help speed-up your downloads."),
        date_str: str = Argument(..., help="Date string used to download the specific malware batch file.")
):
    ec = Console(stderr=True, style="bold red")
    if not hourly:
        url = f"https://datalake.abuse.ch/malware-bazaar/daily/{date_str}.zip"
    else:
        url = f"https://datalake.abuse.ch/malware-bazaar/hourly/{date_str}.zip"
    head = requests.head(url)
    if head.status_code != 200:
        ec.print(f"No batch file for given date found. "
                 f"Maybe you used the wrong date format? (Tried {head.request.url})")
        exit(-1)

    total = int(head.headers.get("Content-Length", 0))
    filename = output or f"{date_str}.zip"
    if quiet:
        with requests.get(url, stream=True) as r:
            with io.open(filename, "wb") as file:
                shutil.copyfileobj(r.raw, file, length=chunk_size)
    else:
        with Progress() as progress:
            progress.print(f"Downloading {date_str}.zip with a size of {total / 1024 ** 2:.2f}MB.")
            task = progress.add_task(f"Downloading {filename}...", total=total)
            with requests.get(url, stream=True) as r:
                with io.open(filename, "wb") as file:
                    for data_chunk in r.iter_content(chunk_size=chunk_size):
                        num_bytes = file.write(data_chunk)
                        progress.update(task, advance=num_bytes)


@bazaar_app.command(name="version", help="Print and check bazaar version.")
def version(
        check: bool = Option(False, "-c", "--check", help="Check if you're using the latest version via Github API.")
):
    check_version(check)


if __name__ == "__main__":
    bazaar_app()
