from datetime import datetime
from typing import List, Optional, Dict, Any

from pydantic import BaseModel, validator


class Sample(BaseModel):
    """Just a simple dictionary wrapper."""
    md5_hash: str
    sha1_hash: str
    sha256_hash: str
    sha3_384_hash: Optional[str] = None
    first_seen: Optional[datetime] = None
    last_seen: Optional[datetime] = None
    file_name: Optional[str] = None
    file_size: int
    file_type_mime: Optional[str] = None
    file_type: Optional[str] = None
    signature: Optional[str] = None
    tags: Optional[List[str]] = None
    imphash: Optional[str] = None
    gimphash: Optional[str] = None
    dhash_icon: Optional[str] = None
    reporter: Optional[str] = None
    telfhash: Optional[str] = None
    tlsh: Optional[str] = None
    origin_country: Optional[str] = None
    anonymous: Optional[bool] = None
    ssdeep: Optional[str] = None
    sightings: Optional[int] = None
    vendor_intel: Optional[Dict[Any, Any]] = None

    def __init__(self, **data):
        tasks = None
        if "metadata" in data:
            tasks = data["tasks"]
            data = data["metadata"]
        super().__init__(
            sha3_384_hash=data.pop("sha3_384", None) or data.pop("sha3_384_hash", None),
            **data
        )

    @validator("first_seen", pre=True)
    def validate_fs(cls, value):
        if not value:
            return value
        try:
            return datetime.strptime(value, "%Y-%m-%d %H:%M:%S")
        except ValueError:
            return datetime.strptime(value, "%Y-%m-%d %H:%M:%S UTC")

    @validator("last_seen", pre=True)
    def validate_ls(cls, value):
        if not value:
            return value
        try:
            return datetime.strptime(value, "%Y-%m-%d %H:%M:%S")
        except ValueError:
            return datetime.strptime(value, "%Y-%m-%d %H:%M:%S UTC")


class YaraRule(BaseModel):
    time_stamp: Optional[datetime] = None
    rule_name: Optional[str] = None
    author: Optional[str] = None
    description: Optional[str] = None
    date: Optional[str] = None
    tlp: Optional[str] = None
    reference: Optional[str] = None
    yarahub_uuid: Optional[str] = None
    yarahub_license: Optional[str] = None
    yarahub_author_twitter: Optional[str] = None
    yarahub_reference_link: Optional[str] = None
    yarahub_reference_md5: Optional[str] = None
    yarahub_rule_matching_tlp: Optional[str] = None
    yarahub_rule_sharing_tlp: Optional[str] = None
    malpedia_family: Optional[str] = None

    @validator("time_stamp", pre=True)
    def validate_ts(cls, value):
        if not value:
            return value
        try:
            return datetime.strptime(value, "%Y-%m-%d %H:%M:%S")
        except ValueError:
            return datetime.strptime(value, "%Y-%m-%d %H:%M:%S UTC")


class UnpackResult(BaseModel):
    unpacked_file_name: Optional[str] = None
    unpacked_md5: Optional[str] = None
    unpacked_sha256: Optional[str] = None
    unpacked_yara_matches: Optional[List[YaraRule]] = None


class Task(BaseModel):
    task_id: Optional[str] = None
    clamav_scan: Optional[bool] = None
    unpack: Optional[bool] = None
    share_file: Optional[bool] = None
    metadata: Optional[Sample] = None
    static_results: Optional[List[YaraRule]] = None
    clamav_results: Optional[List[str]] = None
    unpacked_results: Optional[List[UnpackResult]] = None

    def __init__(self, **data):
        params = data.pop("task_parameters", {})
        unpacked_results = data.pop("unpacked_results", [])
        if len(unpacked_results) == 0:
            unpacked_results = data.pop("unpack_results", [])

        super().__init__(**data, **params, unpacked_results=unpacked_results)
